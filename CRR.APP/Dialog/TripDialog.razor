@using System.Data.Common
@inject AddressService _AddressService
@inject CarService _CarService
@inject TripService _TripService
@inject DefaultTripService _DefaultTripService
@inject DialogService DialogService
@inject GPSService _GPS
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="Trip" Data=@trip Submit=@OnSubmit>
    <RadzenStack Gap="10px">    
        <RadzenFieldset AllowCollapse="!IsEditMode" ExpandTitle="Expand Departure." CollapseTitle="Collapse Departure."
                    ExpandAriaLabel="Expand the list of Departure." CollapseAriaLabel="Collapse the list of Departure." Collapsed=!IsEditMode >
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                    <RadzenIcon Icon="account_box" /><b>Vertrek: </b>@FromTitle
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack>
                    <RadzenRow >
                        <RadzenColumn Size="10">
                            <RadzenFormField Text="Vertrek address" Style="Width: 100%" Variant=Variant.Flat>
                                <RadzenDropDown TValue=Address Value=@trip.From Change=@(args => UpdateFromAddress((Address) args)) TextProperty="@nameof(Address.Name)" Data=@AllAddresses Name="DropDownFrom" />
                                <RadzenRequiredValidator Component="DropDownFrom" Text="Een vertrek adres is verplicht" Popup=true Style="position: absolute"/>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="2">
                            <RadzenButton Click=@(() => CreateAddress(new Address(),AddressChoise.From)) Icon="add_circle" ButtonStyle="ButtonStyle.Primary" />
                        </RadzenColumn>
                    </RadzenRow>
                    
                    <RadzenFormField Text="Kilometerstand vertrek" Variant=Variant.Flat>
                        <RadzenNumeric TValue=int Value=@trip.DepartureMileage Change=@(args => UpdateDepartureMileage((int) args)) Name="DepartureMileage"/>
                        <RadzenNumericRangeValidator Component="DepartureMileage" Min="1" opup=true Text="Kilometerstand moet minimaal 1km zijn!" Style="position: absolute" />
                    </RadzenFormField>
                    <RadzenFormField Text="Vertrek tijd" Variant=Variant.Flat>
                        <RadzenDatePicker TValue=DateTime Value=@trip.Departure Change="@(args => UpdateDepartureTime((DateTime) args))" ShowTime="true" ShowSeconds="true" HoursStep="1" MinutesStep="5"DateFormat="dd-MM-yyyy HH:mm" Name="Vertrektijd" />
                        <RadzenRequiredValidator Component="Vertrektijd" Text="Vertrekijd is verplicht!" Popup=true Style="position: absolute"/>
                    </RadzenFormField>
                </RadzenStack>
            </ChildContent>
            <SummaryTemplate>
                <RadzenStack>
                    <RadzenFormField Text="Vertrek tijd" Variant=Variant.Flat>
                        <RadzenDatePicker TValue=DateTime Value=@trip.Departure Change="@(args => UpdateDepartureTime((DateTime) args))" ShowTime="true" ShowSeconds="true" HoursStep="1" MinutesStep="5"DateFormat="dd-MM-yyyy HH:mm" Name="Vertrektijd" />
                        <RadzenRequiredValidator Component="Vertrektijd" Text="Vertrekijd is verplicht!" Popup=true Style="position: absolute"/>
                    </RadzenFormField>
                </RadzenStack>
            </SummaryTemplate>
        </RadzenFieldset>
        <RadzenFieldset AllowCollapse="false">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                    <RadzenIcon Icon="account_box" /><b>Aankomst: </b>@ToTitle
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack>
                    
                    <RadzenRow >
                        <RadzenColumn Size="10">
                            <RadzenFormField Text="Aankomst address" Style="Width: 100%" Variant=Variant.Flat>
                                <RadzenDropDown Value=@trip.To Change=@(args => UpdateToAddress((Address) args)) TextProperty="@nameof(Address.Name)" Data=@AllAddresses Name="DropDownTo" />
                                <RadzenRequiredValidator Component="DropDownTo" Text="First name is required" Popup=true Style="position: absolute"/>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="2">
                            <RadzenButton Click=@(() => CreateAddress(new Address(),AddressChoise.to)) Icon="add_circle" ButtonStyle="ButtonStyle.Primary" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenFormField Text="Kilometerstand aankomst" Variant=Variant.Flat>
                        <RadzenNumeric TValue=int Value=@trip.ArrivalMileage Name="ArrivalMileage" Change=@(args => UpdateArrivalMileage((int)args)) />
                        <RadzenNumericRangeValidator Component="ArrivalMileage" Min=@trip.DepartureMileage Popup=true Text="Kilometerstand bij aankomst moet groter dan bij vertrek zijn!" Style="position: absolute" />
                    </RadzenFormField>
                    <RadzenFormField Text="Aankomst tijd" Variant=Variant.Flat>
                        <RadzenDatePicker TValue=DateTime Value=@trip.Arrival Change="@(args => UpdateArrivalTime((DateTime) args))" ShowTime="true" ShowSeconds="true" HoursStep="1" MinutesStep="5"DateFormat="dd-MM-yyyy HH:mm" Name="aankomststijd" />
                        <RadzenRequiredValidator Component="aankomststijd" Text="Aankomststijd is verplicht!" Popup=true Style="position: absolute"/>
                    </RadzenFormField>
                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>
        <RadzenFieldset AllowCollapse="false">
            <HeaderTemplate>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                    <RadzenIcon Icon="account_box" /><b>Instellingen</b>
                </RadzenStack>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack>
                    <RadzenFormField Text="Opmerking" Variant=Variant.Flat>
                        <RadzenTextArea  @bind-Value=trip.Remark />
                    </RadzenFormField>
                    <RadzenRow>
                        <RadzenColumn Size="8">
                            <RadzenFormField Text="Prive Kilometers" Variant=Variant.Flat>
                                <RadzenNumeric TValue=int Value=@PrivateMileages Disabled=@FullPrivate Style="width: 100%;" Change=@(args => UpdatePrivateMileages((int)args)) Name="PrivateMileages"/>
                                <RadzenNumericRangeValidator Visible=@(!FullPrivate) Component="PrivateMileages" Max=@(trip.ArrivalMileage - trip.DepartureMileage) Popup=true Text="Privekilometers mogen niet groter zijn dan de totale kilometers!" Style="position: absolute" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenToggleButton @bind-Value=@FullPrivate ButtonStyle="ButtonStyle.Light" ToggleButtonStyle="ButtonStyle.Success" Text="Volledig prive" />
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>
        @if(IsEditMode){
            <RadzenButton ButtonType="ButtonType.Submit" Text="Opslaan" ButtonStyle="ButtonStyle.Primary" />
            <RadzenButton Text="Verwijderen" ButtonStyle="ButtonStyle.Danger" Click=DeleteTrip/>
        } else{
            <RadzenButton ButtonType="ButtonType.Submit" Text="Toevoegen" Style="width: 100%;" ButtonStyle="ButtonStyle.Primary" />
        }
        
    </RadzenStack>
</RadzenTemplateForm>
@code{
    private string FromTitle{get; set;}
    private bool IsEditMode{get; set;} = true;
    private string ToTitle{get; set;}
    private bool FullPrivate{get; set;} = false;
    private int PrivateMileages{get; set;}
    [Parameter]
    public Trip? trip {get; set;} = null;
    private List<Address> AllAddresses {get; set;} = new List<Address>();
    private List<Car> AllCars {get; set;} = new List<Car>();
    protected override async Task OnInitializedAsync(){
        _GPS.GetGPSLocation();

        Trip PreviousTrip = await _TripService.GetLatestAsync();
        AllAddresses = await _AddressService.GetAllAsync();
        AllCars = await _CarService.GetAllAsync();

        if(trip == null){
            trip = new Trip();
            IsEditMode = false;
        
            Car defaulcar  = await _CarService.GetDefaultAsync();
            trip.Car = defaulcar;
            trip.CarId = defaulcar.Id;

            if(PreviousTrip != null){
                trip.DepartureMileage = PreviousTrip.ArrivalMileage;
                trip.From = await _AddressService.GetAsync(PreviousTrip.ToId);
                trip.FromId = PreviousTrip.ToId;
            }

            await AutoFillValues();
        }
        else{
            IsEditMode = true;
            trip.From = AllAddresses.FirstOrDefault(A=> A.Id == trip.FromId);
            trip.To = AllAddresses.FirstOrDefault(A=> A.Id == trip.ToId);
        }

        if(_GPS.Latitude != 0 && _GPS.Longitude != 0){
            AllAddresses = AllAddresses
            .OrderBy(p =>
            {
                double dLat = p.Latitude - _GPS.Latitude;
                double dLon = p.Longitude - _GPS.Longitude;
                return Math.Sqrt(Math.Pow(dLat, 2) + Math.Pow(dLon, 2));
            })
            .ToList();
        }
        else{
            AllAddresses = AllAddresses.OrderBy(A => A.Name).ToList();
        }

        await base.OnInitializedAsync();
    }
    private async Task AutoFillValues()
    {
        FromTitle = BuildTitle(trip.From?.Name, trip.DepartureMileage);
        ToTitle   = BuildTitle(trip.To?.Name, trip.ArrivalMileage);

        if (trip.From != null && trip.To != null && !IsEditMode)
        {
            await ApplyDefaultTripValuesAsync(trip);
        }

        EnsureArrivalDate();

        await Task.Delay(50);
        StateHasChanged();
    }

    private static string BuildTitle(string? locationName, int mileage)
    {
        if (string.IsNullOrWhiteSpace(locationName))
            return string.Empty;

        return mileage > 0 
            ? $"{locationName}  ({mileage} km)" 
            : locationName;
    }

    private async Task ApplyDefaultTripValuesAsync(Trip newTrip)
    {
        var foundDefaultTrip = await _DefaultTripService.GetFromAddresses(newTrip.From.Id, newTrip.To.Id);
        if (foundDefaultTrip == null)
            foundDefaultTrip = await _DefaultTripService.GetFromAddresses(newTrip.To.Id, newTrip.From.Id);

        if (foundDefaultTrip == null)
            return;

        if (newTrip.ArrivalMileage == 0 && newTrip.DepartureMileage != 0)
        {
            newTrip.ArrivalMileage = newTrip.DepartureMileage + foundDefaultTrip.DefaultMileage;
        }

        if (newTrip.Departure == DateTime.MinValue)
        {
            newTrip.Departure = newTrip.Arrival - foundDefaultTrip.TripTime;
        }
    }

    private void EnsureArrivalDate()
    {
        if (trip.Arrival == DateTime.MinValue)
        {
            trip.Arrival = DateTime.Now;
        }
    }

    private void EnsureFallbackArrivalMileage()
    {
        // alleen fallback doen als er nog steeds geen ArrivalMileage staat
        if (trip.ArrivalMileage == 0 && trip.DepartureMileage != 0)
        {
            trip.ArrivalMileage = trip.DepartureMileage + 9;
        }
    }

    private async Task UpdateFromAddress(Address address){
        trip.From = address;
        await AutoFillValues();
    }
    private async Task UpdateToAddress(Address address){
        trip.To = address;
        await AutoFillValues();
    }
    private async Task UpdateDepartureMileage(int DepartureMileage){
        trip.DepartureMileage = DepartureMileage;
        await AutoFillValues();
    }
    private async Task UpdateArrivalMileage(int ArrivalMileage){
        trip.ArrivalMileage = ArrivalMileage;
        await AutoFillValues();
    }
    private async Task UpdateDepartureTime(DateTime DepartureTime)
    {
        trip.Departure = DepartureTime;
        await AutoFillValues();
    }
    private async Task UpdateArrivalTime(DateTime ArrivalTime){
        trip.Arrival = ArrivalTime;
        await AutoFillValues();
    }
    private async Task UpdatePrivateMileages(int PrivateMileages){
        trip.PrivateMileage = PrivateMileages;
        await AutoFillValues();
    }
    async Task OnSubmit(Trip model){
        model.FromId = model.From.Id;
        model.ToId = model.To.Id;

        if(FullPrivate){
            model.PrivateMileage = model.ArrivalMileage - model.DepartureMileage;
        } else{
            model.PrivateMileage = PrivateMileages;
        }

        if(IsEditMode)
            await _TripService.UpdateAsync(model.Id, model);
        else{
            await _TripService.CreateAsync(model);
        }
        
        DialogService.Close();
    }
    async Task DeleteTrip(){
        bool? result = await DialogService.Confirm("Weet je zeker dat je deze rit wilt verwijderen?", "Rit verwijderen", new ConfirmOptions() { OkButtonText = "Ja", CancelButtonText = "Nee" });
        if(result == true){
            await _TripService.DeleteAsync(trip.Id);
            DialogService.Close();
        }
    }
    async Task CreateAddress(Address AddressData,AddressChoise Choise)
    {
         var TripAddress = await DialogService.OpenAsync<CRR.APP.Dialog.AddressDialog>($"Address {AddressData.Name}",
               new Dictionary<string, object>() { { "AddressData", AddressData } },
               new DialogOptions() { Width = "700px", Height = "520px" });
        AllAddresses = await _AddressService.GetAllAsync();
        if(Choise == AddressChoise.From){
            trip.From = AllAddresses.FirstOrDefault(A=>A.ZipCode == TripAddress.ZipCode);
            trip.FromId = AllAddresses.FirstOrDefault(A=>A.ZipCode == TripAddress.ZipCode).Id;
        }
        else{
            trip.To = AllAddresses.FirstOrDefault(A=>A.ZipCode == TripAddress.ZipCode);
            trip.ToId = AllAddresses.FirstOrDefault(A=>A.ZipCode == TripAddress.ZipCode).Id;
        }
        StateHasChanged();
    }
    enum AddressChoise{
        From,
        to
    }
}