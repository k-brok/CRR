@page "/TripList"
@using System.Text.Json
@inject AddressService _AddressService
@inject TripService _TripService
@inject DialogService DialogService
@using System.Text.Json
<PageTitle>Ritten overzicht</PageTitle>

<div class="toolbar" style="display:flex; gap:.75rem; align-items:center; margin-bottom:.5rem;">
    <RadzenButton Text="Controleer" Click=@ProccessTrips Disabled=@CheckRunning />
    <RadzenDropDown @bind-Value=@SelectedYear Data=@Years Placeholder="Filter op jaar" AllowClear="true" Style="width:12rem" />
    @if (CheckRunning)
    {
        <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px" />
    }
</div>

<RadzenDataGrid TItem="Trip"
                Data=@VisibleTrips
                AllowFiltering="true"
                FilterMode="FilterMode.Advanced"
                AllowSorting="true"
                AllowPaging="false"
                ColumnWidth="160px"
                Density=Density.Compact
                Style="height: calc(100vh - 200px);">
    <Columns>
        <RadzenDataGridColumn Property=@nameof(Trip.Departure) Title="Datum" Width="10rem" />
        <RadzenDataGridColumn Title="Van">
            <Columns>
                <RadzenDataGridColumn Title="Adres" Width="260px">
                    <Template Context="trip">
                        @AddressName(trip.FromId)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property=@nameof(Trip.DepartureMileage) Title="Kilometerstand" Width="10rem" TextAlign="TextAlign.Right" />
            </Columns>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="Naar">
            <Columns>
                <RadzenDataGridColumn Title="Adres" Width="260px">
                    <Template Context="trip">
                        @AddressName(trip.ToId)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property=@nameof(Trip.ArrivalMileage) Title="Kilometerstand" Width="10rem" TextAlign="TextAlign.Right" />
            </Columns>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="Kilometers">
            <Columns>
                <RadzenDataGridColumn Title="Zakelijk" Width="8rem" TextAlign="TextAlign.Right">
                    <Template Context="trip">
                        @(trip.ArrivalMileage - trip.DepartureMileage - trip.PrivateMileage)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property=@nameof(Trip.PrivateMileage) Title="PrivÃ©" Width="8rem" TextAlign="TextAlign.Right" />
            </Columns>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="Foutmeldingen" Visible=@CheckHasRun Width="340px">
            <Template Context="trip">
                @if (trip.errors?.Any() == true)
                {
                    <ul style="margin:0; padding-left:1rem">
                        @foreach (var error in trip.errors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                }
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Width="60px">
            <Template Context="trip">
                <RadzenButton Icon="edit" Size="ButtonSize.Small" Style="margin-right: 10px" Click="@(async () => await TripDialogOpen(trip))" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    bool CheckRunning { get; set; }
    bool CheckHasRun { get; set; }

    List<Trip> TripListData { get; set; } = new();
    List<Address> AllAddresses { get; set; } = new();

    // Jaar-filter (zoals gevraagd)
    int? SelectedYear { get; set; }
    List<int> Years { get; set; } = new();

    // Snelle lookup i.p.v. FirstOrDefault in de template
    Dictionary<Guid, Address> AddressById { get; set; } = new();
    string AddressName(Guid id) =>
        AddressById.TryGetValue(id, out var a) ? (a?.Name ?? "(onbekend)") : "(onbekend)";

    // View (jaarfilter + sortering)
    IEnumerable<Trip> VisibleTrips =>
        (SelectedYear is null ? TripListData : TripListData.Where(t => t.Departure.Year == SelectedYear))
        .OrderBy(t => t.Departure);

    protected override async Task OnInitializedAsync()
    {
        TripListData = await _TripService.GetAllAsync();
        AllAddresses = await _AddressService.GetAllAsync();

        // Sorteren en years vullen (recent eerst)
        TripListData = TripListData.OrderBy(t => t.Departure).ToList();
        Years = TripListData.Select(t => t.Departure.Year).Distinct().OrderByDescending(y => y).ToList();

        AddressById = AllAddresses.GroupBy(a => a.Id).ToDictionary(g => g.Key, g => g.First());
        await base.OnInitializedAsync();
    }

    async Task ProccessTrips()
    {
        CheckRunning = true;
        StateHasChanged();

        var carTrips = new List<CarTrip>();
        foreach (var trip in TripListData.OrderBy(t => t.Departure))
        {
            var currentCar = carTrips.FirstOrDefault(c => c.CarId == trip.CarId);
            if (currentCar is null)
            {
                currentCar = new CarTrip { CarId = trip.CarId };
                carTrips.Add(currentCar);
            }

            if (currentCar.LastTrip != null &&
                currentCar.LastTrip.ArrivalMileage != trip.DepartureMileage)
            {
                trip.errors ??= new List<string>();
                trip.errors.Add("Vertrek-kilometers komen niet overeen met de voorgaande rit.");
            }

            currentCar.LastTrip = trip;
        }

        await Task.Delay(50);
        CheckRunning = false;
        CheckHasRun = true;
        StateHasChanged();
    }

    async Task TripDialogOpen(Trip trip){
        var result = await DialogService.OpenAsync<CRR.APP.Dialog.TripDialog>($"Rit bewerken",new Dictionary<string, object>()
        {
            {"Trip", trip}
        },new DialogOptions(){ Width="700px"});

        TripListData = await _TripService.GetAllAsync();
        StateHasChanged();
        
    }
    class CarTrip{
        public Trip? LastTrip {get; set;} = null;
        public Guid CarId {get; set;}
    }
}
